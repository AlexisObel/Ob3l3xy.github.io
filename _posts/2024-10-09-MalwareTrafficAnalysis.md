---
title: Malware Traffic Analysis (Big Fish In A Little Pond)
date: 2024-10-09 12:57:00 +3
categories: SOC
tags: [SOC, Malware Traffic Analysis, Wireshark, VirusTotal]
image: 
  path: /assets/img/BigFish.JPG
---
<p style="text-align: justify;">
Malware activity can be detected from the processes that it executes on the computers. More information on the malware activity can be found through static and dynamic analysis on it. Network traffic can also provide more information about malware. Analyzing malware traffic is important because it helps you understand what malware is capable of, and with that knowledge, you can properly safeguard your network and systems. In the event of an incident, appropriate measures can be put in place to respond to malware-related incidents.
The exercise was from malware-traffic-analysis.net, and I started with the most recent exercise called Big Fish In A Little Pond. 
</p>


## Lab Information 
### Environment 

* **LAN segment range:** 172.17.0.0/24 (172.17.0.0 through 172.17.0.255)
* **Domain:** bepositive.com
* **AD environment name:** BEPOSITIVE
* **Domain Controller:** 172.17.0.17 - WIN-CTL9XBQ9Y19
* **LAN segment gateway:** 172.17.0.1
* **LAN segment broadcast address:** 172.17.0.255

### Background
While reviewing the alerts in the network environment, I found indicators that a
host within my environment had been infected with malware.


![Alt Text](/assets/img/2024-09-04-traffic-analysis-exercise-alerts.JPG)
_Screenshot of alerts_

## The Malware Traffic Analysis Process
### Finding the Victim's Details 

Filtered DHCP packets to find the host name.

![Alt Text](/assets/img/bf1.JPG)

Another filter that was equally effective was using Netbios. The domain controller **WIN-CTL9XBQ9Y19** was spotted in the process.

![Alt Text](/assets/img/bf2.JPG)

Filtered DHCP packets to find the victim's MAC and IP address.

![Alt Text](/assets/img/bf3.JPG)

Filtered Kerberos packets to find the victim's Windows user account name.

![Alt Text](/assets/img/bf4.JPG)

Both of the victims names could also be found using **ldap.AttributeDescription == 'givenName'** filter.

![Alt Text](/assets/img/bf5.JPG)

## Indicators of Compromise 
### Malicious website visited 
Filtered for HTTPS traffic using ssl. Of all the https traffic, most of them were just visits to bing and msn hence I picked on the few websites that I wasn't familiar with. 

![Alt Text](/assets/img/bf6.JPG)

Searched for the malicious link on virustotal and it was flagged malicious. 

![Alt Text](/assets/img/bf7.JPG)

### Malicious traffic tied to the SIEM alerts

I referred back to the SIEM alerts and focused on the alert that indicated an alert associated with the **ETPRO TROJAN Win32/Koi Stealer** malware Which is known to steal Information
from the infected machine. Through the trojan the attacker connects to the target machine and it communicates back to the C2 server with data being stolen by the attacker.

![Alt Text](/assets/img/bf8.JPG)

For further analysis I refered to the alerts and took note of the destination IP address (79.124.78.197) and the port associated with it (49816) in order to find traffic tied to the Koi stealer Trojan that was detected by the SIEM.

![Alt Text](/assets/img/bf9.JPG)

Multiple similar and unusual POST requests to the target destination IP address were sent which I found to be very suspicious. Typically POST requests are when submitting data to forms and API’s but this was sent to /foots.php

![Alt Text](/assets/img/bf10.JPG)

## Summary of Findings 
**Victim's Information**
* **Host Name:** DESKTOP-RNVO9AT
* **IP address:** 172.17.0.99
* **MAC address:** 18:3d:a2:b6:8d:c4
* **User account name:** afletcher 
* **Victim's full name:** Andrew Fletcher 

**Indicators of Compromise**
* **Malicious website found:** `www.bellantonicioccolato.it` (Danger zone! ⚠️)
* **SIEM Alert:** ETPRO TROJAN Win32/Koi Stealer CnC Checkin (POST) M2
* **Traffic information tied to SIEM alert:** 
  * 79.124.78.197 - POST /index.php?id=&subid=qIOuKk7U 
  * 79.124.78.197 - POST /foots.php - occured multiple times which is very suspicious













